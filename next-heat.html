<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>ä¸‹ä¸€ç‚‰ç”Ÿæˆå™¨ Â· SteelTool</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&family=Noto+Sans+SC:wght@300;400;500&display=swap');

:root{
  --bg:#0d0f14;--surface:#161b24;--border:#252d3a;
  --accent:#e07b00;--accent2:#ff9f1c;--steel:#8fa3b1;
  --text:#d4dce5;--text-dim:#5a6a78;--danger:#ff4d4f;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Noto Sans SC',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:16px}
body::before{content:'';position:fixed;inset:0;background-image:repeating-linear-gradient(0deg,transparent,transparent 39px,rgba(255,255,255,0.015) 39px,rgba(255,255,255,0.015) 40px),repeating-linear-gradient(90deg,transparent,transparent 39px,rgba(255,255,255,0.015) 39px,rgba(255,255,255,0.015) 40px);pointer-events:none;z-index:0}

.container{position:relative;z-index:1;max-width:900px;margin:0 auto}

/* é¡¶éƒ¨å¯¼èˆª */
.topbar{
  display:flex;align-items:center;gap:16px;
  padding:14px 0 20px;
  border-bottom:1px solid var(--border);
  margin-bottom:24px;
}
.back-btn{
  text-decoration:none;color:var(--text-dim);font-size:13px;
  display:flex;align-items:center;gap:6px;
  padding:6px 12px;border:1px solid var(--border);border-radius:6px;
  transition:all 0.15s;
}
.back-btn:hover{color:var(--text);border-color:var(--accent)}
.page-title{
  font-family:'Rajdhani',sans-serif;
  font-size:22px;font-weight:700;letter-spacing:2px;color:#fff;
}
.page-title span{color:var(--accent)}

.section-label{
  font-size:11px;letter-spacing:2px;color:var(--text-dim);
  text-transform:uppercase;margin:20px 0 8px;
  display:flex;align-items:center;gap:8px;
}
.section-label .n{
  width:18px;height:18px;border-radius:50%;
  background:var(--accent);color:#000;
  font-size:11px;font-weight:700;
  display:inline-flex;align-items:center;justify-content:center;
  flex-shrink:0;
}
.section-label::after{content:'';flex:1;height:1px;background:var(--border)}

textarea{
  width:100%;font-size:13px;line-height:1.9;
  padding:12px 14px;
  background:var(--surface);color:var(--text);
  border:1px solid var(--border);border-radius:8px;
  resize:vertical;font-family:'Noto Sans SC',Consolas,monospace;
  transition:border 0.2s;
}
textarea:focus{outline:none;border-color:var(--accent)}
textarea::placeholder{color:var(--text-dim)}

.row{display:flex;align-items:center;gap:10px;margin-top:8px}
.row input{
  width:90px;font-size:15px;padding:8px 12px;
  background:var(--surface);color:var(--text);
  border:1px solid var(--border);border-radius:8px;text-align:center;
  font-family:inherit;transition:border 0.2s;
}
.row input:focus{outline:none;border-color:var(--accent)}
.row span{font-size:13px;color:var(--steel)}

.btn-row{display:flex;gap:12px;margin-top:24px}
.btn{
  flex:1;padding:14px 0;font-size:15px;font-weight:500;
  border:none;border-radius:8px;cursor:pointer;
  font-family:'Noto Sans SC',sans-serif;
  transition:all 0.15s;letter-spacing:1px;
}
.btn-main{background:var(--accent);color:#000}
.btn-main:hover{background:var(--accent2)}
.btn-copy{background:var(--surface);color:var(--text);border:1px solid var(--border)}
.btn-copy:hover{border-color:var(--accent);color:var(--accent)}
.btn-copy.copied{background:rgba(82,196,26,0.1);border-color:#52c41a;color:#52c41a}

.clear-btn{
  margin-top:8px;padding:7px 14px;font-size:12px;letter-spacing:1px;
  background:transparent;color:var(--danger);
  border:1px solid rgba(255,77,79,0.3);border-radius:6px;cursor:pointer;
  transition:all 0.15s;font-family:inherit;
}
.clear-btn:hover{background:rgba(255,77,79,0.1)}

.toast{
  display:none;position:fixed;bottom:28px;left:50%;
  transform:translateX(-50%);
  background:#1e2530;color:var(--text);
  border:1px solid var(--border);
  padding:10px 22px;border-radius:8px;
  font-size:13px;z-index:999;pointer-events:none;
  box-shadow:0 4px 20px rgba(0,0,0,0.5);
}
</style>
</head>
<body>
<div class="container">
  <div class="topbar">
    <a class="back-btn" href="index.html">â† è¿”å›é¦–é¡µ</a>
    <div class="page-title">ğŸ”¥ ä¸‹ä¸€ç‚‰<span>ç”Ÿæˆå™¨</span></div>
  </div>

  <div class="section-label"><span class="n">1</span> ç‚¼é’¢å·¥ä½œç¾¤å·¥è‰ºè®°å½•è¡¨</div>
  <textarea id="record" rows="18" placeholder="ç²˜è´´å½“å‰ç‚‰å·¥è‰ºè®°å½•..."></textarea>

  <button class="clear-btn" onclick="clearRecord()">æ¸…é™¤å·¥è‰ºè®°å½•</button>

  <div class="section-label"><span class="n">2</span> é’¢åŒ…å‘¨è½¬è®¡åˆ’è¡¨</div>
  <textarea id="ladle" rows="7" placeholder="æ”¯æŒæ ¼å¼â‘  1#é’¢åŒ… åŒ…é¾„3 120t  æˆ–  â‘¡ 11å·åŒ…é¾„21æ¬¡ç‚‰å·01760å‡ºé’¢é‡165å¨"></textarea>
  <button class="clear-btn" onclick="clearLadle()">æ¸…é™¤é’¢åŒ…è®¡åˆ’è¡¨</button>

  <div class="section-label"><span class="n">3</span> å‡ºé’¢æ—¶é—´å¢åŠ ï¼ˆåˆ†é’Ÿï¼‰</div>
  <div class="row">
    <input id="addMinute" type="number" value="40" min="0" max="240">
    <span>åˆ†é’Ÿ</span>
  </div>

  <div class="btn-row">
    <button class="btn btn-main" onclick="nextHeat()">âš™ ä¸€é”®ç”Ÿæˆä¸‹ä¸€ç‚‰</button>
    <button class="btn btn-copy" id="copyBtn" onclick="copyText()">å¤åˆ¶å†…å®¹</button>
  </div>
</div>
<div class="toast" id="toast"></div>

<script>
let ladles=[];

function normalize(text){
  return text
    .replace(/[ï¼-ï¼™]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xFEE0))
    .replace(/[ï¼¡-ï¼ºï½-ï½š]/g,c=>String.fromCharCode(c.charCodeAt(0)-0xFEE0))
    .replace(/[ï¼šï¹•ï¸“]/g,':')
    .replace(/ï¼ƒ/g,'#')
    .replace(/å¨/g,'t')
    .replace(/ã€€/g,' ');
}

function parseLadles(){
  ladles=[];
  normalize(document.getElementById("ladle").value).split(/\n/).forEach(l=>{
    l=l.trim();
    if(!l) return;
    let no, age, ton, heatNo;
    // æ ¼å¼2ï¼š11å·åŒ…é¾„21æ¬¡ç‚‰å·01760å‡ºé’¢é‡165å¨
    let m2=l.match(/(\d+)\s*å·\s*åŒ…é¾„\s*(\d+)\s*æ¬¡.*?ç‚‰å·\s*(\d+).*?å‡ºé’¢é‡\s*(\d+)\s*[tå¨]/i);
    // æ ¼å¼1ï¼š1#é’¢åŒ… åŒ…é¾„3 120t æˆ– 1å·é’¢åŒ… åŒ…é¾„3 120t
    let m1=l.match(/(\d+)[#å·].*?åŒ…é¾„\s*(\d+).*?(\d+)\s*[tå¨]/i);
    if(m2){ no=m2[1]; age=Number(m2[2]); heatNo=m2[3]; ton=Number(m2[4]); }
    else if(m1){ no=m1[1]; age=Number(m1[2]); ton=Number(m1[3]); }
    if(no!==undefined) ladles.push({no, age, ton, heatNo});
  });
}

function clearRecord(){document.getElementById("record").value=""}
function clearLadle(){document.getElementById("ladle").value=""}

// éšæœºä¸€ä¸ª0~9çš„æ•°å­—ï¼Œä½†ä¸ç­‰äº exclude
function randDigitExclude(exclude){
  let d;
  do{ d=Math.floor(Math.random()*10); }while(d===exclude);
  return d;
}

// ä¿æŒåä½ï¼Œä¸ªä½éšæœºä¸”ä¸ç­‰äºæ—§ä¸ªä½
function randomLastDigitDiff(num){
  let oldDigit = num % 10;
  let newDigit = randDigitExclude(oldDigit);
  if(num<10) return Math.max(1, newDigit===0 ? 1 : newDigit);
  return Math.floor(num/10)*10 + newDigit;
}

function addTime(text,addMin){
  return text.replace(/å‡ºé’¢æ—¶é—´\s*:\s*(\d{1,2})\s*:\s*(\d{1,2})/,(_, h,m)=>{
    let d=new Date();
    d.setHours(Number(h),Number(m),0,0);
    d.setMinutes(d.getMinutes()+addMin);
    let hh=String(d.getHours()).padStart(2,"0");
    let mm=String(d.getMinutes()).padStart(2,"0");
    return `å‡ºé’¢æ—¶é—´:      ${hh}   :  ${mm}`;
  });
}

// åˆé‡‘ä¸‹æ–™æ—¶é—´ï¼šéšæœºä½†ä¸ç­‰äºæ—§å€¼
function updateAlloyTime(text){
  return text.replace(/åˆé‡‘ä¸‹æ–™æ—¶é—´\s*:\s*(\d+)/,(_, oldNum)=>{
    let v=Number(oldNum);
    let newV;
    let oldDigit = v % 10;
    if(v>=50&&v<=59){
      // 50~55èŒƒå›´å†…éšæœºï¼Œä¸”ä¸ç­‰äºæ—§å€¼
      do{ newV=50+Math.floor(Math.random()*6); }while(newV===v);
    } else {
      let newDigit = randDigitExclude(oldDigit);
      newV = Math.floor(v/10)*10 + newDigit;
    }
    return `åˆé‡‘ä¸‹æ–™æ—¶é—´:   ${newV}`;
  });
}

// å®é™…è£…é‡è®¡ç®—è§„åˆ™
function calcActualWeight(ton, text){
  const rand22 = () => Math.floor(Math.random() * 5) - 2; // -2 ~ +2

  if(ton === 165){
    return 165 + [15, 16, 17][Math.floor(Math.random() * 3)];
  }

  if(ton === 170 || ton === 175){
    let gradeMatch = text.match(/é’¢\s*ç§\s*:\s*([^\n\s]+)/);
    let grade = gradeMatch ? gradeMatch[1] : "";
    if(grade.includes("355")){
      return Math.round(ton * 1.063) + rand22();
    } else if(grade.includes("235")){
      return Math.round(ton * 1.07) + rand22();
    } else {
      return ton + 5 + rand22();
    }
  }

  if(ton === 180){
    return 180 + 5 + rand22();
  }

  return ton + 5;
}

// ç»ˆç‚¹æ°®å«é‡ï¼šéšæœºä½†ä¸ç­‰äºæ—§å€¼ï¼ˆå…¼å®¹æ•´æ•°å’Œå°æ•°æ ¼å¼ï¼‰
const nitrogenValues=["0.003","0.0023","0.0017","0.0028","0.0014"];
function updateNitrogen(text){
  return text.replace(/ç»ˆç‚¹æ°®å«é‡\s*:\s*(\S+)/,(full, oldVal)=>{
    let candidates = nitrogenValues.filter(v=>v!==oldVal);
    let newVal = candidates[Math.floor(Math.random()*candidates.length)];
    return `ç»ˆç‚¹æ°®å«é‡ï¼š    ${newVal}`;
  });
}

function nextHeat(){
  let raw=document.getElementById("record").value;
  if(!raw.trim()){showToast("âš  è¯·å…ˆç²˜è´´å½“å‰ç‚‰å·¥è‰ºè®°å½•");return}
  parseLadles();
  let addMin=Number(document.getElementById("addMinute").value)||40;
  let t=normalize(raw);

  t=t.replace(/ç¬¬\s*(\d+)\s*ç‚‰/,(_,n)=>`ç¬¬   ${+n+1}   ç‚‰`);
  t=t.replace(/ç‚‰å·\s*:\s*(\d+)/,(_,n)=>`ç‚‰å·ï¼š${+n+1}`);
  t=addTime(t,addMin);
  t=updateAlloyTime(t);

  // åˆé‡‘ç”¨é‡ï¼šä¸ªä½éšæœºï¼Œä½†ä¸ç­‰äºä¸Šä¸€ç‚‰ä¸ªä½
  ["ç¡…é”°","ç¡…é“","é“é“","ä½ç¢³é”°é“","é‡‘å±é”°","ä½é”°","é«˜ç¢³é“¬é“","é«˜é“¬","é“¬é“"].forEach(a=>{
    t=t.replace(new RegExp(`${a}\\s*:\\s*(\\d+)`,"g"),(_,num)=>{
      let n=Number(num);
      let newN=randomLastDigitDiff(n);
      return `${a}ï¼š       ${newN}`;
    });
  });

  let carbonMatch=t.match(/ç»ˆç‚¹ç¢³\s*:\s*(\d+)/);
  if(carbonMatch){
    let carbon=Number(carbonMatch[1]);
    t=carbon<=7
      ?t.replace(/\/\s*\d+\s*åŒ…/,"/   0åŒ…")
      :t.replace(/\/\s*\d+\s*åŒ…/,`/   ${Math.floor(Math.random()*5)+10}åŒ…`);
  }

  // ç»ˆç‚¹æ°®å«é‡ï¼šä¸ç­‰äºä¸Šä¸€ç‚‰
  t=updateNitrogen(t);

  if(ladles.length>0){
    let cur=t.match(/é’¢\s*åŒ…\s*å·\s*:\s*(\d+)/);
    let idx=-1;
    if(cur){
      idx=ladles.findIndex(l=>l.no===cur[1]);
      if(idx===-1) showToast(`âš  é’¢åŒ…å· ${cur[1]}# æœªåœ¨è®¡åˆ’è¡¨ä¸­æ‰¾åˆ°ï¼Œä»ç¬¬1ä¸ªå¼€å§‹`);
    }
    let next=ladles[(idx+1)%ladles.length];
    t=t.replace(/é’¢\s*åŒ…\s*å·\s*:\s*\d+/,`é’¢ åŒ… å·ï¼š      ${next.no}`);
    t=t.replace(/åŒ…\s*é¾„\s*:\s*\d+/,`åŒ…      é¾„ï¼š      ${next.age}`);
    t=t.replace(/è¦\s*æ±‚é’¢é‡\s*:\s*\d+/,`è¦ æ±‚é’¢é‡ï¼š     ${next.ton}`);
    t=t.replace(/å®\s*é™…è£…é‡\s*:\s*\d+/,`å® é™…è£…é‡ï¼š     ${calcActualWeight(next.ton, t)}`);
  }

  document.getElementById("record").value=t;
}

function copyText(){
  let text=document.getElementById("record").value;
  if(!text.trim()){showToast("âš  å†…å®¹ä¸ºç©º");return}
  navigator.clipboard.writeText(text).then(()=>{
    let btn=document.getElementById("copyBtn");
    btn.textContent="âœ… å·²å¤åˆ¶";btn.classList.add("copied");
    setTimeout(()=>{btn.textContent="å¤åˆ¶å†…å®¹";btn.classList.remove("copied")},2000);
  }).catch(()=>{
    let ta=document.createElement("textarea");ta.value=text;
    document.body.appendChild(ta);ta.select();document.execCommand("copy");document.body.removeChild(ta);
    showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
  });
}

function showToast(msg){
  let el=document.getElementById("toast");
  el.textContent=msg;el.style.display="block";
  clearTimeout(el._t);el._t=setTimeout(()=>{el.style.display="none"},2500);
}
</script>
</body>
</html>
